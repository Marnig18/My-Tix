<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>MyTix</title>

		<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.min.css">
	<link rel="stylesheet" href="../src/css/app.css">
	<link href="https://fonts.googleapis.com/css?family=Abel|Alegreya+Sans|Alegreya+Sans+SC|Alfa+Slab+One|Anton|Audiowide|Baloo+Bhaina|Baloo+Paaji|Cinzel|Days+One|Fjalla+One|Fredoka+One|Fugaz+One|Marcellus|Old+Standard+TT|Raleway|Righteous|Roboto|Roboto+Condensed|Slabo+27px|Vollkorn" rel="stylesheet">
	<link rel="stylesheet" href="./index.css">
	<script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE="
  crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/jsbarcode/3.5.1/JsBarcode.all.min.js"></script>
	

<body>
	<noscript>
      You need to enable JavaScript to run this app.
    </noscript>
    <div id="root"></div>
    <div id="dataArea">
    	<div class="whiteText" id="dataBkgd">Detailed Event Data</div>
    	<form id="dataForm">
	    	<input type="text" placeholder="Enter Event Name" id="inputForData">
				<button id="eventGraph">Event Data</button>
			</form>
    </div>
<!-- 		<form>
		<input type="text" name="option" id="option" placeholder="Enter option">
		<button type="submit" text="Choose Option" id="chooseOption">Choose Option</button>
		</form> -->
	<!-- Graph generation -->
		<p align="center">
    <!--This draws the Canvas on the webpage -->
      <canvas id="mycanvas"></canvas> 
    </p>

 <script src="https://cdn.jsdelivr.net/processing.js/1.4.8/processing.min.js"></script> 
 <script>
  // Canvas script

	// Bar Graph
	$(document).on('click', '#eventGraph', function(event){
		var revenue = [];
    var items = [];
    var numberBought = 0;
    var totalTickets = 0;
		event.preventDefault();
		var eventSearch = $('#inputForData').val();
		$('#inputForData').val('');
		console.log("Clicked");

		$.ajax({
		url: "/api/eventSearch/" + eventSearch,
		method:"GET"
}).done(function(result){
		  console.log(result[0]);
		  for(var i in result[0].Option){
		  	console.log(result[0].Option[i].optionName);
		  	console.log(result[0].Option[i].optionPrice);
		  	console.log(result[0].Option[i].optionQuantity);
		  	items.push(result[0].Option[i].optionName);
		  	revenue.push(result[0].Option[i].optionPrice * result[0].Option[i].optionQuantity);
		  	numberBought += result[0].Option[i].numberBought;
		  	totalTickets += result[0].Option[i].optionQuantity;
		  	console.log("In loop");
		  	console.log(totalTickets);
		  	// revenue.push should be optionPrice * numberBought
		  }
	console.log("Out of loop ")
	console.log(totalTickets);
	var sketchProc = function(processingInstance) {
  with (processingInstance) {
    size(1000, 650);
    frameRate(30);	

	background(0, 0, 0);	
	var x = 10;
	// Grab maximum revenue value for setting y-axis Max
	var z = revenue.reduce(function(a, b) {
		return Math.max(a, b);
	});
	var maxRev = z;
	var labelRev = maxRev;
	// Evenly spaced y intervals
	var revYSpacing = maxRev/10;

	var spacing = 80;
	width = 25;
	// Graph Title
	textSize(20);
	fill(255, 255, 255);
	ctx.font="bold 30px Arial";
  text(result[0].Name  + " Revenue", 280, 50);
  // Y label
  fill(255, 255, 255);
  textSize(12);
  fill(255, 255, 255);
	text("$", 10, 300);
	// Y and X edge lines
	fill(255, 255, 255);
	stroke(255, 255, 255);
	line(80, 80, 80, 540);
	line(80, 540, 700, 540);
	// Generate yLabel array, First 2 are empty for spacing from top
	var yLabels = ["", ""];
	for(var i = 0; i<10; i++){
		yLabels.push(labelRev);
		labelRev -= revYSpacing;
	}
	yLabels.push(0);
	var y = 0;
	// Draw the y axis labels
	for(var i in yLabels){
		text(yLabels[i], 45, y);
		y+=45;
	}

	// Scales bar height to canvas window based on max revenue.
	// Generate bar heights per ticket type
	// Label the x-axis with items array

	ctx.font="bold 14px Arial";
	text("Ticket Type", canvas.width/2 - 100, 620);
	ctx.font="12px Arial";
	for(var key in revenue){
		if(revenue[key] === maxRev){
			var height = 450;
			fill(0, 26, 70);
			rect(x + spacing, 540-height, x+width, height);
			fill(250, 250, 250);
			text(items[key], x + spacing, 580);

			spacing+=150;
		}
		else{
			var height = revenue[key]/maxRev * 450;
			fill(0, 26, 70);
			rect(x + spacing, 540-height, x+width, height);
			fill(250, 250, 250);
			text(items[key], x + spacing, 580);

			spacing+=150;
		}
	}

	// Arc Graph
	var x2 = canvas.width / 1.25;
  var y2 = canvas.height / 3.5;
  var radius = 75;
  var startAngle = (0 + 1.5) * Math.PI;
  var endAngle = (2 + 1.5) * Math.PI;
  var counterClockwise = false;
  ctx.beginPath();
  ctx.arc(x2, y2, radius, startAngle, endAngle, counterClockwise);
  ctx.lineWidth = 15;
  // line color
  ctx.strokeStyle = 'white';
  ctx.stroke();

  // Arc data
  var EventPercent = numberBought / totalTickets;
  var EventArc = (EventPercent * 2 + 1.5) * Math.PI;
  ctx.beginPath();
  ctx.arc(x2, y2, radius, startAngle, EventArc, counterClockwise);
  ctx.lineWidth = 15;
  // Arc color
  ctx.strokeStyle = ('green');
  ctx.stroke();

  // Arc Text Labels
  ctx.font="20px Arial";
  text("% Tickets Sold", (canvas.width/1.60 + 100), (canvas.height/8))
  ctx.font="30px Arial";
  text(EventPercent * 100, (canvas.width/1.28 - 20), (canvas.height/3.5 + 10))
  var remaining = totalTickets - numberBought;
  ctx.font="20px Arial";
  text("Tickets Remaining", (canvas.width/1.60 + 100), (canvas.height/2));
  text(remaining, (canvas.width/1.60 + 100), (canvas.height/1.8));
  ctx.font="20px Arial";
  text("Total Revenue", (canvas.width/1.60 + 100), (canvas.height/1.2));
  var total = 0;
  for(var i = 0; i < revenue.length; i++){
  	total += revenue[i];
  	if(i==revenue.length-1){
  		ctx.font="30px Arial";
  		text(total, (canvas.width/1.60 + 100), (canvas.height/1.1))
  	}
  }
  $('#mycanvas').css('border', "solid 2px #4A6EA9");
  }};

  // Get the canvas that Processing-js will use
  var canvas = document.getElementById("mycanvas");
	var ctx = canvas.getContext("2d");
  // Pass the function sketchProc (defined in myCode.js) to Processing's constructor.

  var processingInstance = new Processing(canvas, sketchProc);
 		});	
	})
 </script>
 <script>

 </script>
    <footer>&copy; 2017 MyTix
		</footer>
</body>
</html>
